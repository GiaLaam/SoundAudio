@using Microsoft.Extensions.Configuration
@inject IConfiguration Configuration
@model List<MyWebApp.Models.Album>
@{
    ViewData["Title"] = "Quản lý album";
    var apiBaseUrl = Configuration["ApiSettings:BaseUrl"] ?? "http://localhost:5289";
    var totalAlbums = Model?.Count ?? 0;
}

@section Styles {
    <link rel="stylesheet" href="~/css/admin.css" />
}

<!-- Toast Data -->
@if (TempData["Success"] != null)
{
    <div data-toast-success="@TempData["Success"]" style="display:none;"></div>
}
@if (TempData["Error"] != null)
{
    <div data-toast-error="@TempData["Error"]" style="display:none;"></div>
}

<section class="section">
    <!-- Header -->
    <div class="admin-header">
        <h2><i class="fas fa-compact-disc"></i> Quản lý album</h2>
        <button class="btn-primary" onclick="openModal('addAlbumModal')">
            <i class="fas fa-plus"></i> Thêm album
        </button>
    </div>

    <!-- Stats -->
    <div class="stats-row">
        <div class="stat-card">
            <div class="stat-icon blue">
                <i class="fas fa-compact-disc"></i>
            </div>
            <div>
                <div class="stat-value">@totalAlbums</div>
                <div class="stat-label">Tổng album</div>
            </div>
        </div>
    </div>

    <!-- Table -->
    <div class="admin-table-container">
        <table class="admin-table">
            <thead>
                <tr>
                    <th data-sort="name" class="sortable">Album</th>
                    <th>Số bài hát</th>
                    <th>Hành động</th>
                </tr>
            </thead>
            <tbody id="albumTableBody">
                @if (Model != null && Model.Any())
                {
                    @foreach (var album in Model)
                    {
                        var imageUrl = string.IsNullOrEmpty(album.ImageUrl) ? "/images/logo.png" : apiBaseUrl + album.ImageUrl;
                        <tr data-id="@album.Id" data-name="@album.Name">
                            <td>
                                <div class="song-cell">
                                    <img src="@imageUrl" alt="@album.Name" class="song-image" />
                                    <div class="song-info">
                                        <span class="song-name">@album.Name</span>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <span class="album-badge">-</span>
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <button class="btn-action edit" onclick="editAlbum('@album.Id')" title="Sửa">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn-action delete" onclick="deleteAlbum('@album.Id', '@album.Name.Replace("'", "\\'")' )" title="Xóa">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="3">
                            <div class="empty-state">
                                <i class="fas fa-compact-disc"></i>
                                <h3>Chưa có album nào</h3>
                                <p>Nhấn nút "Thêm album" để bắt đầu</p>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
        
        <!-- Pagination -->
        <div class="pagination-container" id="pagination">
            <div class="pagination-info">
                Hiển thị @totalAlbums album
            </div>
        </div>
    </div>
</section>

<!-- Add Album Modal -->
<div id="addAlbumModal" class="admin-modal">
    <div class="admin-modal-content">
        <div class="admin-modal-header">
            <h3><i class="fas fa-plus-circle"></i> Thêm album mới</h3>
            <button class="admin-modal-close" onclick="closeModal('addAlbumModal')">×</button>
        </div>
        <form asp-controller="Admin" asp-action="AddAlbum" method="post" enctype="multipart/form-data">
            <div class="admin-modal-body">
                <div class="form-group">
                    <label><i class="fas fa-heading"></i> Tên album</label>
                    <input type="text" name="name" required placeholder="Nhập tên album..." />
                </div>
                
                <div class="form-group">
                    <label><i class="fas fa-image"></i> Hình ảnh</label>
                    <div class="file-upload" id="albumImageUpload">
                        <div class="file-upload-icon"><i class="fas fa-image"></i></div>
                        <div class="file-upload-text">
                            Kéo thả ảnh hoặc <span>chọn ảnh</span>
                        </div>
                        <input type="file" name="imageFile" accept="image/*" 
                               onchange="previewImage(this, 'albumImagePreview')" />
                    </div>
                    <div class="image-preview" id="albumImagePreview"></div>
                </div>
            </div>
            <div class="admin-modal-footer">
                <button type="button" class="btn-secondary" onclick="closeModal('addAlbumModal')">
                    <i class="fas fa-times"></i> Hủy
                </button>
                <button type="submit" class="btn-primary">
                    <i class="fas fa-plus"></i> Thêm album
                </button>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script src="~/js/admin.js"></script>
    <script>
        // Delete Album
        function deleteAlbum(id, name) {
            if (confirm(`Bạn có chắc muốn xóa album "${name}"?`)) {
                fetch('/Admin/DeleteAlbum/' + id, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                })
                .then(response => {
                    if (response.ok) {
                        Toast.success('Xóa album thành công!');
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        Toast.error('Xóa album thất bại');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    Toast.error('Có lỗi xảy ra');
                });
            }
        }
        
        // Edit Album
        function editAlbum(id) {
            window.location.href = '/Admin/EditAlbum/' + id;
        }
    </script>
}
