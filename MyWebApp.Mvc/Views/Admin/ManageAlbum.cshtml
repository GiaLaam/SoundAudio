@using Microsoft.Extensions.Configuration
@inject IConfiguration Configuration
@model List<MyWebApp.Models.Album>
@{
    ViewData["Title"] = "Quản lý album";
    var apiBaseUrl = Configuration["ApiSettings:BaseUrl"] ?? "http://localhost:5289";
}

<section class="section">
    <div class="section-header">
        <h2 class="section-title">Quản lý album</h2>
        <button class="primary-btn" onclick="openAddAlbumModal()">
            <i class="fas fa-plus"></i> Thêm album
        </button>
    </div>

    @if (ViewBag.Success != null)
    {
        <div class="alert alert-success" style="padding: 12px; background-color: rgba(29, 185, 84, 0.1); border: 1px solid var(--spotify-green); border-radius: 8px; margin-bottom: 20px; color: var(--spotify-green);">
            @ViewBag.Success
        </div>
    }

    @if (ViewBag.Error != null)
    {
        <div class="alert alert-danger" style="padding: 12px; background-color: rgba(255, 0, 0, 0.1); border: 1px solid #ff0000; border-radius: 8px; margin-bottom: 20px; color: #ff0000;">
            @ViewBag.Error
        </div>
    }

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Hình ảnh</th>
                    <th>Tên album</th>
                    <th>Số bài hát</th>
                    <th>Hành động</th>
                </tr>
            </thead>
            <tbody>
                @if (Model != null && Model.Any())
                {
                    @foreach (var album in Model)
                    {
                        <tr>
                            <td>
                                <img src="@(string.IsNullOrEmpty(album.ImageUrl) ? "/images/default-album.jpg" : apiBaseUrl + album.ImageUrl)" 
                                     alt="@album.Name" 
                                     style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px;" />
                            </td>
                            <td>@album.Name</td>
                            <td>-</td>
                            <td>
                                <button class="action-btn" onclick="editAlbum('@album.Id')" title="Sửa">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="action-btn" onclick="deleteAlbum('@album.Id', '@album.Name')" title="Xóa" style="color: #ff0000;">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="4" style="text-align: center; color: var(--spotify-light-gray); padding: 40px;">
                            Chưa có album nào
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</section>

<!-- Add Album Modal -->
<div id="addAlbumModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Thêm album mới</h3>
            <button class="modal-close" onclick="closeAddAlbumModal()">&times;</button>
        </div>
        <form asp-controller="Admin" asp-action="AddAlbum" method="post" enctype="multipart/form-data">
            <div class="form-group">
                <label>Tên album</label>
                <input type="text" name="name" required />
            </div>
            <div class="form-group">
                <label>Hình ảnh</label>
                <input type="file" name="imageFile" accept="image/*" />
            </div>
            <div class="modal-actions">
                <button type="button" class="secondary-btn" onclick="closeAddAlbumModal()">Hủy</button>
                <button type="submit" class="primary-btn">Thêm</button>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script>
        function openAddAlbumModal() {
            document.getElementById('addAlbumModal').style.display = 'flex';
        }

        function closeAddAlbumModal() {
            document.getElementById('addAlbumModal').style.display = 'none';
        }

        function editAlbum(id) {
            window.location.href = '/Admin/EditAlbum/' + id;
        }

        function deleteAlbum(id, name) {
            if (confirm('Bạn có chắc muốn xóa album "' + name + '"?')) {
                fetch('/Admin/DeleteAlbum/' + id, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => {
                    if (response.ok) {
                        location.reload();
                    } else {
                        alert('Xóa album thất bại');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Có lỗi xảy ra');
                });
            }
        }

        window.onclick = function(event) {
            const modal = document.getElementById('addAlbumModal');
            if (event.target == modal) {
                closeAddAlbumModal();
            }
        }
    </script>
}
