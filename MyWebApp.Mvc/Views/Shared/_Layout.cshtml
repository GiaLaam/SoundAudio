@inject Microsoft.AspNetCore.Identity.UserManager<MyWebApp.Models.ApplicationUser> UserManager
@inject IConfiguration Configuration
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - SoundAudio</title>
    <link rel="stylesheet" href="~/css/main.css?v=@DateTime.Now.Ticks" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
    @await RenderSectionAsync("Styles", required: false)
</head>
<body data-api-base="@(Configuration["ApiSettings:BaseUrl"] ?? "http://localhost:5289")" data-authenticated="@(User.Identity?.IsAuthenticated == true ? "true" : "")">
    @{
        var isAuthenticated = User.Identity?.IsAuthenticated ?? false;
        var isAuthPage = ViewContext.RouteData.Values["controller"]?.ToString() == "Home" && 
                        (ViewContext.RouteData.Values["action"]?.ToString() == "Login" || 
                         ViewContext.RouteData.Values["action"]?.ToString() == "Register");
    }

    @if (!isAuthPage)
    {
        <div class="main-container">
            <aside class="sidebar">
                <div class="sidebar-logo">
                    <i class="fas fa-music"></i> SoundAudio
                </div>
                
                <ul class="sidebar-menu">
                    <li>
                        <a href="/" class="@(ViewContext.RouteData.Values["action"]?.ToString() == "Index" && ViewContext.RouteData.Values["controller"]?.ToString() == "Home" ? "active" : "")">
                            <i class="fas fa-home"></i>
                            <span>Trang chủ</span>
                        </a>
                    </li>
                    <li>
                        <a href="/Album">
                            <i class="fas fa-compact-disc"></i>
                            <span>Albums</span>
                        </a>
                    </li>
                    
                    @if (isAuthenticated)
                    {
                        var user = await UserManager.GetUserAsync(User);
                        var isAdmin = user != null && await UserManager.IsInRoleAsync(user, "Admin");
                        
                        @if (isAdmin)
                        {
                            <li><hr style="border-color: #282828; margin: 12px 0;" /></li>
                            <li>
                                <a href="/Admin/Dashboard" class="@(ViewContext.RouteData.Values["controller"]?.ToString() == "Admin" && ViewContext.RouteData.Values["action"]?.ToString() == "Dashboard" ? "active" : "")">
                                    <i class="fas fa-chart-line"></i>
                                    <span>Dashboard</span>
                                </a>
                            </li>
                            <li>
                                <a href="/Admin/ManageMusic" class="@(ViewContext.RouteData.Values["action"]?.ToString() == "ManageMusic" ? "active" : "")">
                                    <i class="fas fa-music"></i>
                                    <span>Quản lý nhạc</span>
                                </a>
                            </li>
                            <li>
                                <a href="/Admin/ManageAlbum" class="@(ViewContext.RouteData.Values["action"]?.ToString() == "ManageAlbum" ? "active" : "")">
                                    <i class="fas fa-compact-disc"></i>
                                    <span>Quản lý album</span>
                                </a>
                            </li>
                        }
                        else
                        {
                            <li><hr style="border-color: #282828; margin: 12px 0;" /></li>
                            <li>
                                <a href="/User/Profile" class="@(ViewContext.RouteData.Values["action"]?.ToString() == "Profile" ? "active" : "")">
                                    <i class="fas fa-user"></i>
                                    <span>Trang cá nhân</span>
                                </a>
                            </li>
                            <li>
                                <a href="/User/Playlist" class="@(ViewContext.RouteData.Values["action"]?.ToString() == "Playlist" ? "active" : "")">
                                    <i class="fas fa-list"></i>
                                    <span>Playlist</span>
                                </a>
                            </li>
                        }
                    }
                </ul>

                @if (isAuthenticated)
                {
                    <div class="sidebar-logout">
                        <form asp-controller="Home" asp-action="Logout" method="post">
                            <button type="submit" class="logout-btn">
                                <i class="fas fa-sign-out-alt"></i>
                                Đăng xuất
                            </button>
                        </form>
                    </div>
                }
            </aside>

            <main class="main-content">
                <div class="top-bar">
                    <form asp-controller="Home" asp-action="Search" method="get" class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" name="query" placeholder="Tìm bài hát, album..." />
                    </form>

                    <div class="user-menu">
                        @if (isAuthenticated)
                        {
                            var user = await UserManager.GetUserAsync(User);
                            <div class="user-profile" onclick="window.location.href='/User/Profile'" style="cursor: pointer;">
                                <div class="user-avatar">
                                    <i class="fas fa-user"></i>
                                </div>
                                <span class="user-name">@(user?.FullName ?? user?.Email ?? "User")</span>
                            </div>
                        }
                        else
                        {
                            <a href="/Home/Register" class="btn btn-secondary">Đăng ký</a>
                            <a href="/Home/Login" class="btn btn-primary">Đăng nhập</a>
                        }
                    </div>
                </div>

                <div class="content-wrapper">
                    @RenderBody()
                </div>
            </main>
            
            <!-- Audio Player -->
            <div id="audioPlayer" class="audio-player" style="display: none;">
                <audio id="audioElement"></audio>
                <div class="player-controls">
                    <div class="player-song-info">
                        <img id="playerThumbnail" src="/images/logo.png" alt="Song" class="player-thumbnail" />
                        <div class="player-details">
                            <div id="playerSongName" class="player-song-name">Chọn bài hát</div>
                            <div id="playerArtist" class="player-artist">SoundAudio</div>
                        </div>
                    </div>
                    
                    <div class="player-center">
                        <div class="player-buttons">
                            <button id="prevBtn" class="player-btn"><i class="fas fa-step-backward"></i></button>
                            <button id="playBtn" class="player-btn player-btn-main"><i class="fas fa-play"></i></button>
                            <button id="nextBtn" class="player-btn"><i class="fas fa-step-forward"></i></button>
                        </div>
                        <div class="player-progress">
                            <span id="currentTime">0:00</span>
                            <div class="progress-bar">
                                <div class="progress-fill"></div>
                                <input type="range" id="progressBar" min="0" max="100" value="0" class="progress-slider" />
                            </div>
                            <span id="duration">0:00</span>
                        </div>
                    </div>
                    
                    <div class="player-extra">
                        <button id="devicesBtn" class="player-btn" title="Thiết bị phát nhạc">
                            <i class="fas fa-desktop"></i>
                        </button>
                        <button id="lyricsBtn" class="player-btn" title="Lời bài hát">
                            <i class="fas fa-microphone-alt"></i>
                        </button>
                        <div class="player-volume">
                            <button id="muteBtn" class="player-btn"><i class="fas fa-volume-up"></i></button>
                            <input type="range" id="volumeSlider" min="0" max="100" value="70" class="volume-slider" />
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Lyrics Panel -->
            <div id="lyricsPanel" class="lyrics-panel">
                <button id="closeLyricsBtn" class="lyrics-close-btn">
                    <i class="fas fa-chevron-down"></i>
                </button>
                <div class="lyrics-panel-content">
                    <div id="lyricsContent" class="lyrics-text">
                        <div class="lyrics-placeholder">
                            <i class="fas fa-music"></i>
                            <p>Chọn một bài hát để xem lời</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Lyrics Panel Overlay -->
            <div id="lyricsOverlay" class="lyrics-overlay"></div>
        </div>
    }
    else
    {
        @RenderBody()
    }

    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>
    <script src="~/js/site.js" asp-append-version="true"></script>
    <script src="~/js/playback-session.js" asp-append-version="true"></script>
    <script src="~/js/player-simple.js" asp-append-version="true"></script>
    @await RenderSectionAsync("Scripts", required: false)
</body>
</html>