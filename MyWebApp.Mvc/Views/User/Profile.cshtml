@using Microsoft.AspNetCore.Identity
@using MyWebApp.Models
@inject UserManager<ApplicationUser> UserManager
@{
    ViewData["Title"] = "Hồ sơ cá nhân";
    var user = await UserManager.GetUserAsync(User);
    var initials = !string.IsNullOrEmpty(user?.FullName) ? user.FullName.Substring(0, 1).ToUpper() : "U";
}

@section Styles {
    <link rel="stylesheet" href="~/css/Profile.css?v=@DateTime.Now.Ticks" />
}

<div class="user-profile-page">
    <div class="profile-header">
        <div class="profile-cover"></div>
        <div class="profile-info">
            <div class="profile-avatar">
                <span class="avatar-initials">@initials</span>
                <div class="avatar-glow"></div>
            </div>
            <div class="profile-meta">
                <span class="profile-label">Hồ sơ</span>
                <h1 class="profile-name">@(user?.FullName ?? "Người dùng")</h1>
                <div class="profile-stats">
                    <span class="stat-item">
                        <i class="fas fa-envelope"></i> @user?.Email
                    </span>
                    <span class="stat-divider">•</span>
                    <span class="stat-item status-verified">
                        <i class="fas fa-check-circle"></i> Đã xác thực
                    </span>
                    <span class="stat-divider">•</span>
                    <span class="stat-item">
                        <i class="fas fa-user-tag"></i>
                        @if (User.IsInRole("Admin"))
                        {
                            <text>Quản trị viên</text>
                        }
                        else
                        {
                            <text>Người dùng</text>
                        }
                    </span>
                </div>
            </div>
        </div>
    </div>

    <div class="profile-content">
        @if (ViewBag.Success != null)
        {
            <div class="alert alert-success">
                <i class="fas fa-check-circle"></i>
                <span>@ViewBag.Success</span>
            </div>
        }

        @if (ViewBag.Error != null)
        {
            <div class="alert alert-error">
                <i class="fas fa-exclamation-circle"></i>
                <span>@ViewBag.Error</span>
            </div>
        }

        <div class="profile-sections">
            <div class="profile-section">
                <div class="section-card">
                    <div class="section-card-header">
                        <i class="fas fa-user-edit"></i>
                        <h3>Thông tin cá nhân</h3>
                    </div>
                    <form asp-controller="User" asp-action="UpdateProfile" method="post" class="profile-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label><i class="fas fa-user"></i> Tên đầy đủ</label>
                                <input type="text" name="fullName" value="@user?.FullName" required class="form-input" />
                            </div>
                            <div class="form-group">
                                <label><i class="fas fa-envelope"></i> Email</label>
                                <input type="email" value="@user?.Email" readonly class="form-input readonly" />
                                <span class="form-hint">Email không thể thay đổi</span>
                            </div>
                        </div>
                        <button type="submit" class="btn-save">
                            <i class="fas fa-save"></i> Lưu thay đổi
                        </button>
                    </form>
                </div>
            </div>

            <div class="profile-section">
                <div class="section-card">
                    <div class="section-card-header">
                        <i class="fas fa-lock"></i>
                        <h3>Đổi mật khẩu</h3>
                    </div>
                    <form asp-controller="User" asp-action="UpdateProfile" method="post" class="profile-form">
                        <input type="hidden" name="fullName" value="@user?.FullName" />
                        <div class="form-group">
                            <label><i class="fas fa-key"></i> Mật khẩu hiện tại</label>
                            <div class="password-input-wrapper">
                                <input type="password" name="currentPassword" placeholder="Nhập mật khẩu hiện tại" class="form-input" />
                                <button type="button" class="toggle-password"><i class="fas fa-eye"></i></button>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label><i class="fas fa-lock"></i> Mật khẩu mới</label>
                                <div class="password-input-wrapper">
                                    <input type="password" name="newPassword" placeholder="Nhập mật khẩu mới" class="form-input" />
                                    <button type="button" class="toggle-password"><i class="fas fa-eye"></i></button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label><i class="fas fa-lock"></i> Xác nhận mật khẩu</label>
                                <div class="password-input-wrapper">
                                    <input type="password" name="confirmNewPassword" placeholder="Xác nhận mật khẩu mới" class="form-input" />
                                    <button type="button" class="toggle-password"><i class="fas fa-eye"></i></button>
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="btn-save btn-password">
                            <i class="fas fa-shield-alt"></i> Cập nhật mật khẩu
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.querySelectorAll('.toggle-password').forEach(btn => {
            btn.addEventListener('click', function() {
                const input = this.previousElementSibling;
                const icon = this.querySelector('i');
                if (input.type === 'password') {
                    input.type = 'text';
                    icon.classList.remove('fa-eye');
                    icon.classList.add('fa-eye-slash');
                } else {
                    input.type = 'password';
                    icon.classList.remove('fa-eye-slash');
                    icon.classList.add('fa-eye');
                }
            });
        });
    </script>
}
