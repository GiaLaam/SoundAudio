@using Microsoft.Extensions.Configuration
@inject IConfiguration Configuration
@model List<MyWebApp.Models.MusicFile>
@{
    ViewData["Title"] = "Kết quả tìm kiếm";
    var apiBaseUrl = Configuration["ApiSettings:BaseUrl"] ?? "http://localhost:5289";
    var albums = ViewBag.Albums as List<MyWebApp.Models.Album> ?? new List<MyWebApp.Models.Album>();
    var searchQuery = ViewBag.SearchQuery as string ?? "";
}

<div class="search-page">
    <!-- Search Header -->
    <div class="search-header">
        <h1 class="search-title">
            @if (!string.IsNullOrEmpty(searchQuery))
            {
                <span>Kết quả tìm kiếm cho "</span><span class="search-query">@searchQuery</span><span>"</span>
            }
            else
            {
                <span>Tất cả nội dung</span>
            }
        </h1>
        <p class="search-summary">
            Tìm thấy <strong>@Model.Count</strong> bài hát và <strong>@albums.Count</strong> album
        </p>
    </div>

    <!-- Albums Section -->
    @if (albums.Any())
    {
        <section class="section">
            <div class="section-header">
                <h2 class="section-title">Albums</h2>
            </div>
            <div class="grid">
                @foreach (var album in albums)
                {
                    <div class="card" 
                         data-album-id="@album.Id"
                         onclick="window.location.href='/Album/Details/@album.Id'">
                        <div class="card-image">
                            @if (!string.IsNullOrEmpty(album.ImageUrl))
                            {
                                <img src="@(apiBaseUrl + album.ImageUrl)" alt="@album.Name" />
                            }
                            else
                            {
                                <div class="card-placeholder">
                                    <i class="fas fa-compact-disc"></i>
                                </div>
                            }
                            <button class="play-btn" onclick="event.stopPropagation();"><i class="fas fa-play"></i></button>
                        </div>
                        <div class="card-title">@album.Name</div>
                        <div class="card-subtitle">Album</div>
                    </div>
                }
            </div>
        </section>
    }

    <!-- Songs Section -->
    @if (Model != null && Model.Any())
    {
        <section class="section">
            <div class="section-header">
                <h2 class="section-title">Bài hát</h2>
            </div>
            <div class="list-view">
                @for (int i = 0; i < Model.Count; i++)
                {
                    var song = Model[i];
                    <div class="list-item" 
                         data-song-id="@song.Id" 
                         data-song-name="@song.NameSong" 
                         data-song-artist="Unknown Artist" 
                         data-song-image="@song.ImageUrl"
                         style="cursor: pointer;">
                        <div class="song-number">@(i + 1)</div>
                        <div class="song-info">
                            <div class="song-image">
                                <img src="@(string.IsNullOrEmpty(song.ImageUrl) ? "/images/logo.png" : apiBaseUrl + song.ImageUrl)" alt="@song.NameSong" />
                            </div>
                            <div class="song-details">
                                <div class="song-name">@song.NameSong</div>
                            </div>
                        </div>
                        <div class="song-actions">
                            @if (User.Identity?.IsAuthenticated == true)
                            {
                                <button class="action-btn add-to-playlist-btn" data-song-id="@song.Id" title="Thêm vào playlist" onclick="event.stopPropagation();">
                                    <i class="fas fa-plus"></i>
                                </button>
                            }
                        </div>
                    </div>
                }
            </div>
        </section>
    }

    <!-- No Results -->
    @if ((Model == null || !Model.Any()) && !albums.Any())
    {
        <section class="section" style="text-align: center; padding: 80px 20px;">
            <i class="fas fa-search" style="font-size: 64px; color: var(--spotify-light-gray); margin-bottom: 20px; opacity: 0.5;"></i>
            <h2 style="color: var(--spotify-white); margin-bottom: 10px;">Không tìm thấy kết quả</h2>
            <p style="color: var(--spotify-light-gray);">Thử tìm kiếm với từ khóa khác</p>
        </section>
    }
</div>

<!-- Add to Playlist Modal -->
@if (User.Identity?.IsAuthenticated == true)
{
    <div id="addToPlaylistModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Thêm vào playlist</h3>
                <button class="modal-close" onclick="closeAddToPlaylistModal()">&times;</button>
            </div>
            <div id="playlistList" style="max-height: 400px; overflow-y: auto;">
                <p style="text-align: center; color: var(--spotify-light-gray); padding: 20px;">Đang tải...</p>
            </div>
            <div class="modal-actions">
                <button type="button" class="secondary-btn" onclick="closeAddToPlaylistModal()">Hủy</button>
            </div>
        </div>
    </div>
}

@section Styles {
    <style>
        .search-page {
            padding: 20px 0;
        }

        .search-header {
            margin-bottom: 32px;
            padding: 0 20px;
        }

        .search-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--spotify-white);
            margin-bottom: 8px;
        }

        .search-query {
            color: var(--spotify-green);
        }

        .search-summary {
            color: var(--spotify-light-gray);
            font-size: 14px;
        }

        .search-summary strong {
            color: var(--spotify-white);
        }
    </style>
}

@section Scripts {
    <script>
        let currentSongId = null;

        // Add to playlist functionality
        $('.add-to-playlist-btn').on('click', function(e) {
            e.stopPropagation();
            currentSongId = $(this).data('song-id');
            openAddToPlaylistModal();
        });

        function openAddToPlaylistModal() {
            $('#addToPlaylistModal').css('display', 'flex');
            loadPlaylists();
        }

        function closeAddToPlaylistModal() {
            $('#addToPlaylistModal').css('display', 'none');
            currentSongId = null;
        }

        function loadPlaylists() {
            $.ajax({
                url: '@Configuration["ApiSettings:BaseUrl"]/api/playlist/all',
                method: 'GET',
                xhrFields: {
                    withCredentials: true
                },
                success: function(response) {
                    const playlists = response.data || response.playlists || response;
                    if (playlists && playlists.length > 0) {
                        let html = '';
                        playlists.forEach(playlist => {
                            html += `
                                <div class="list-item" style="cursor: pointer; border-bottom: 1px solid var(--spotify-darker);" onclick="addToPlaylist('${playlist.id}')">
                                    <div class="song-info">
                                        <div class="song-image">
                                            <div class="card-placeholder" style="width: 50px; height: 50px; border-radius: 4px;">
                                                <i class="fas fa-list-ul" style="font-size: 20px;"></i>
                                            </div>
                                        </div>
                                        <div class="song-details">
                                            <div class="song-name">${playlist.name}</div>
                                            <div class="song-artist">${playlist.musicIds ? playlist.musicIds.length : 0} bài hát</div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                        $('#playlistList').html(html);
                    } else {
                        $('#playlistList').html(`
                            <div style="text-align: center; padding: 40px;">
                                <i class="fas fa-list-ul" style="font-size: 48px; color: var(--spotify-light-gray); margin-bottom: 15px;"></i>
                                <p style="color: var(--spotify-light-gray);">Bạn chưa có playlist nào</p>
                                <a href="/User/Playlist" class="primary-btn" style="display: inline-block; margin-top: 15px;">Tạo playlist</a>
                            </div>
                        `);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error loading playlists:', error);
                    $('#playlistList').html('<p style="text-align: center; color: #ff0000; padding: 20px;">Lỗi khi tải playlist</p>');
                }
            });
        }

        function addToPlaylist(playlistId) {
            if (!currentSongId || !playlistId) return;

            $.ajax({
                url: '@Configuration["ApiSettings:BaseUrl"]/api/playlist/add-song',
                method: 'POST',
                contentType: 'application/json',
                xhrFields: {
                    withCredentials: true
                },
                data: JSON.stringify({
                    playlistId: playlistId,
                    songId: currentSongId
                }),
                success: function(response) {
                    alert('Đã thêm bài hát vào playlist!');
                    closeAddToPlaylistModal();
                },
                error: function(xhr, status, error) {
                    console.error('Error adding to playlist:', error);
                    alert('Lỗi khi thêm vào playlist');
                }
            });
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('addToPlaylistModal');
            if (event.target == modal) {
                closeAddToPlaylistModal();
            }
        }
    </script>
}
